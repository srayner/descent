<!DOCTYPE html>
<html>
  <head>
    <title>Algorithm</title>
    <style>
      svg {
        background-color: gray;
      }
    </style>
  </head>
  <body>
    <svg id="canvas" width="1000" height="500" viewBox="-500 -250 1000 500">
      <g id="people"></g>
    </svg>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
      var families = {
        f1: { id: "f1", father: "p1", mother: "p2", children: ["p7"] },
        f2: { id: "f2", father: "p3", mother: "p4", children: ["p8"] },
        f3: {
          id: "f3",
          father: "p5",
          mother: "p6",
          children: ["p10", "p11", "p12"]
        },
        f4: { id: "f4", father: "p7", mother: "p8", children: ["p13"] },
        f5: { id: "f5", father: "p9", mother: "p10", children: ["p15"] },
        f6: { id: "f6", father: "p12", mother: "p13", children: ["p16"] },
        f7: { id: "f7", father: "p14", mother: "p13", children: ["p17"] }
      };

      var people = {
        p1: { name: "p1", gender: "male", parents: null, spouces: ["f1"] },
        p2: { name: "p2", gender: "female", parents: null, spouces: ["f1"] },
        p3: { name: "p3", gender: "male", parents: null, spouces: ["f2"] },
        p4: { name: "p4", gender: "female", parents: null, spouces: ["f2"] },
        p5: { name: "p5", gender: "male", parents: null, spouces: ["f3"] },
        p6: { name: "p6", gender: "female", parents: null, spouces: ["f3"] },
        p7: { name: "p7", gender: "male", parents: "f1", spouces: ["f4"] },
        p8: { name: "p8", gender: "female", parents: "f2", spouces: ["f4"] },
        p9: { name: "p9", gender: "male", parents: null, spouces: ["f5"] },
        p10: { name: "p10", gender: "female", parents: "f3", spouces: ["f5"] },
        p11: { name: "p11", gender: "female", parents: "f3", spouces: [] },
        p12: { name: "p12", gender: "male", parents: "f3", spouces: ["f6"] },
        p13: {
          name: "p13",
          gender: "female",
          parents: "f4",
          spouces: ["f6", "f7"]
        },
        p14: { name: "p14", gender: "male", parents: null, spouces: ["f7"] },
        p15: { name: "p15", gender: "male", parents: "f5", spouces: [] },
        p16: { name: "p16", gender: "female", parents: "f6", spouces: [] },
        p17: { name: "p17", gender: "male", parents: "f7", spouces: [] }
      };

      var curX = -400;
      var curY = 0;
      var familiesAdded = {};
      var peopleAdded = {};

      function locationOccupied(id, x, y) {
        var result = false;
        Object.keys(peopleAdded).forEach(key => {
          if (
            peopleAdded[key].x === x &&
            peopleAdded[key].y === y &&
            key !== id
          ) {
            result = true;
          }
        });
        Object.keys(familiesAdded).forEach(key => {
          if (familiesAdded[key].x === x && familiesAdded[key].y === y) {
            result = true;
          }
        });

        return result;
      }

      function addSpouces(p, x, y) {
        p.spouces.map((key, index) => {
          if (index % 2 === 0) {
            addFamilyNode(families[key], x + 50, y); // to the right of person
          } else {
            addFamilyNode(families[key], x - 50, y); // to the left of person
          }
        });
      }

      function addChildren(f, x, y) {
        f.children.map((key, index) => {
          addPersonNode(people[key], x, y);
        });
      }

      function addFamilyNode(f, x, y) {
        console.log("add family @ " + x + ", " + y);
        console.log(f);

        // Already added?
        if (familiesAdded[f.id]) {
          console.log("already added, returning...");
          return familiesAdded[f.id];
        }

        // Add family node to specified position
        var family = { x, y };
        d3.select("g")
          .append("circle")
          .attr("r", 10)
          .attr("cx", family.x)
          .attr("cy", family.y)
          .attr("stroke", "black")
          .attr("fill", "transparent");
        d3.select("g")
          .append("text")
          .attr("x", family.x)
          .attr("y", family.y + 4)
          .attr("text-anchor", "middle")
          .attr("font-size", "12px")
          .attr("font-weight", "600")
          .text(f.id);
        familiesAdded[f.id] = family;

        // ensure mother and father exist
        var father = addPersonNode(people[f.father], x - 50, y);
        var mother = addPersonNode(people[f.mother], x + 50, y);

        // add any potential children
        addChildren(f, family.x, family.y + 50);

        return family;
      }

      function addPersonNode(p, x, y) {
        console.log("add person @ " + x + ", " + y);
        console.log(p);

        // Already added?
        if (peopleAdded[p.name]) {
          console.log("already added, returning person...");
          return peopleAdded[p.name];
        }

        // Move person to the right if the location is occupied.
        var person = { x, y };
        while (locationOccupied(p.id, person.x, person.y)) {
          person.x += 50;
        }

        // Add the personNode
        d3.select("g")
          .append("text")
          .attr("x", person.x)
          .attr("y", person.y)
          .attr("text-anchor", "middle")
          .attr("font-size", "12px")
          .attr("font-weight", "600")
          .text(p.name);
        peopleAdded[p.name] = person;
        curX = curX + 100;

        // Has parent family?
        if (p.parents) {
          addFamilyNode(families[p.parents], x, y - 50); // above this person
        }

        // Add any potential spouces
        addSpouces(p, x, y);

        return person;
      }

      function addPeople() {
        Object.keys(people).map(key => {
          addPersonNode(people[key], curX, curY);
        });
      }

      addPeople();
    </script>
  </body>
</html>
